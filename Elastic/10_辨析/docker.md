çŸ¥è¯†ç‚¹ï¼šdocker compose

æˆ‘å·²çŸ¥ï¼š

docker composeåªæ˜¯ä¸€ä¸ªéƒ¨ç½²å®¹å™¨çš„å·¥å…·ï¼Œå½“éƒ¨ç½²ä¹‹åï¼Œå®¹å™¨å°±è‡ªå·±è¿è¡Œï¼Œä¸ä¼šå†å—åˆ°docker composeçš„å½±å“ï¼Œè¿™æ—¶å€™å†ä¿®æ”¹å¯¹åº”çš„æ–‡ä»¶ä¹Ÿä¸ä¼šå¯¹äºå®¹å™¨æœ‰ä»»ä½•å½±å“ã€‚

å®é™…ä¸Šï¼Œcomposeæ–‡ä»¶åªä¸è¿‡æ˜¯æŠŠå¤šä¸ªdocker runçš„å‘½ä»¤æ‰“åŒ…èµ·æ¥äº†è€Œå·²ã€‚

æˆ‘ä¸æ‡‚ï¼šdocker composeçš„ç¼–å†™æ–¹æ³•å’Œdocker runæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œdocker composeèƒ½å¦ä½¿ç”¨docker runçš„å…¨éƒ¨æ•ˆæœã€‚

æ€ä¹ˆæ ·ä¿®æ”¹è¿è¡Œæ—¶å®¹å™¨ï¼Ÿ

è¯·ä½ æŒ‰é¡ºåºåšï¼š

1) ç”¨æœ€å°‘æ¦‚å¿µè§£é‡Š docker composeï¼ˆä¸è¶…è¿‡ 120 å­—ï¼‰

2) ç»™ 3 ä¸ªç±»æ¯”ï¼Œä½†æŒ‡å‡ºç±»æ¯”å“ªé‡Œä¼šè¯¯å¯¼

3) é—®æˆ‘ 5 ä¸ªé€’è¿›é—®é¢˜æ¥æ£€æŸ¥ç†è§£ï¼ˆå…ˆåˆ«ç»™ç­”æ¡ˆï¼‰

4) æˆ‘å›ç­”åï¼Œä½ å†æŒ‡å‡ºæˆ‘çš„æ¼æ´å¹¶çº æ­£





å¥½çš„ï¼æˆ‘ä»¬æŒ‰é¡ºåºæ¥ã€‚

---

### 1) ç”¨æœ€å°‘æ¦‚å¿µè§£é‡Š docker composeï¼ˆä¸è¶…è¿‡ 120 å­—ï¼‰

Docker Compose æ˜¯ä¸€ä¸ªé€šè¿‡ YAML æ–‡ä»¶å®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨çš„å·¥å…·ï¼Œå®ƒèƒ½ä¸€é”®å¯åŠ¨ã€åœæ­¢å’Œç®¡ç†å¤šä¸ªå…³è”å®¹å™¨åŠå…¶ç½‘ç»œã€å·ç­‰èµ„æºã€‚

---

### 2) ç»™ 3 ä¸ªç±»æ¯”ï¼Œä½†æŒ‡å‡ºç±»æ¯”å“ªé‡Œä¼šè¯¯å¯¼

**ç±»æ¯” 1ï¼š**  
> â€œDocker Compose å°±åƒæŠŠå¤šä¸ª docker run å‘½ä»¤å†™è¿›ä¸€ä¸ªè„šæœ¬é‡Œã€‚â€  
> âœ… ç›´è§‚ä½“ç°äº†â€œæ‰¹é‡æ‰§è¡Œâ€çš„ä½œç”¨ã€‚  
> âŒ **è¯¯å¯¼ç‚¹**ï¼šCompose ä¸åªæ˜¯æ‰§è¡Œå‘½ä»¤ï¼Œè¿˜ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€ä¾èµ–ã€ç½‘ç»œã€æœåŠ¡çŠ¶æ€ä¸€è‡´æ€§ï¼›ä¿®æ”¹ compose æ–‡ä»¶åå¯é€šè¿‡ `docker compose up` è‡ªåŠ¨æ›´æ–°å®¹å™¨ï¼ˆå¦‚é‡å»ºï¼‰ï¼Œè€Œæ™®é€šè„šæœ¬ä¸ä¼šè·Ÿè¸ªçŠ¶æ€ã€‚

**ç±»æ¯” 2ï¼š**  
> â€œCompose æ–‡ä»¶å°±åƒèœè°±ï¼Œdocker run æ˜¯æ‰‹åŠ¨ç‚’èœã€‚â€  
> âœ… å¼ºè°ƒå£°æ˜å¼ vs å‘½ä»¤å¼ã€‚  
> âŒ **è¯¯å¯¼ç‚¹**ï¼šèœè°±åšå®Œå°±å®Œäº†ï¼Œä½† Compose èƒ½æŒç»­ç®¡ç†æœåŠ¡ï¼ˆå¦‚é‡å¯å¤±è´¥å®¹å™¨ã€ä¿æŒæœŸæœ›çŠ¶æ€ï¼‰ï¼Œæ›´åƒâ€œæ™ºèƒ½å¨æˆ¿ç³»ç»Ÿâ€è€Œéä¸€æ¬¡æ€§èœè°±ã€‚

**ç±»æ¯” 3ï¼š**  
> â€œDocker Compose æ˜¯å®¹å™¨ç‰ˆçš„ systemdï¼Œç®¡ç†ä¸€ç»„æœåŠ¡ã€‚â€  
> âœ… éƒ½æ¶‰åŠæœåŠ¡ç¼–æ’ã€ä¾èµ–ã€å¯åœã€‚  
> âŒ **è¯¯å¯¼ç‚¹**ï¼šsystemd ç®¡ç†çš„æ˜¯ä¸»æœºè¿›ç¨‹ï¼Œè€Œ Compose ç®¡ç†çš„æ˜¯éš”ç¦»çš„å®¹å™¨å®ä¾‹ï¼Œä¸”ä¸å¤„ç†å®¿ä¸»æœºèµ„æºè°ƒåº¦æˆ–å®‰å…¨ä¸Šä¸‹æ–‡ï¼ŒæŠ½è±¡å±‚çº§ä¸åŒã€‚

---

### 3) é—®ä½  5 ä¸ªé€’è¿›é—®é¢˜æ¥æ£€æŸ¥ç†è§£ï¼ˆå…ˆåˆ«ç»™ç­”æ¡ˆï¼‰

è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š

1. å¦‚æœä½ åœ¨ `docker-compose.yml` ä¸­ä¿®æ”¹äº†æŸä¸ªæœåŠ¡çš„ç¯å¢ƒå˜é‡ï¼Œç„¶åç›´æ¥è¿è¡Œ `docker compose up`ï¼ˆä¸åŠ å‚æ•°ï¼‰ï¼Œè¿™ä¸ªä¿®æ”¹ä¼šç”Ÿæ•ˆå—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
   1. ä¼šç”Ÿæ•ˆï¼Œå†è¿è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œå®ƒåº”è¯¥ä¼šè‡ªåŠ¨æ£€æŸ¥å’ŒåŸæ¥çš„å‘½ä»¤çš„å·®å¼‚ï¼Œå†å¯¹äºæœåŠ¡ä¸­çš„å®¹å™¨è¿›è¡Œæ›´æ–°ã€‚

   2. æ‰€ä»¥ï¼Œæˆ‘å¥½å¥‡æ€ä¹ˆåšåˆ°æ£€æŸ¥è¿™ç§å·®å¼‚çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé‡å¤è¿è¡Œdocker compose upçš„å‘½ä»¤ä¸ä¼šåå¤å»ºç«‹æ–°å®¹å™¨ï¼Œé¿å…é‡å¤çš„æœºåˆ¶æ˜¯å®¹å™¨åç§°å—ï¼Ÿ

2. `docker run -p 8080:80 nginx` å’Œåœ¨ Compose æ–‡ä»¶ä¸­ç”¨ `ports: ["8080:80"]` å¯åŠ¨ nginxï¼Œæ•ˆæœå®Œå…¨ç­‰ä»·å—ï¼Ÿæœ‰æ²¡æœ‰ç»†å¾®å·®åˆ«ï¼Ÿ
   1. æˆ‘è®¤ä¸ºæ˜¯ç­‰ä»·çš„ã€‚

3. èƒ½å¦åœ¨ Compose æ–‡ä»¶ä¸­å®ç° `docker run --rm` çš„æ•ˆæœï¼ˆå®¹å™¨é€€å‡ºåè‡ªåŠ¨åˆ é™¤ï¼‰ï¼Ÿå¦‚æœèƒ½ï¼Œæ€ä¹ˆå†™ï¼Ÿ
   1. ä¸çŸ¥é“ã€‚

4. å¦‚æœä¸€ä¸ª Compose é¡¹ç›®å·²ç»è¿è¡Œï¼Œä½ æ‰‹åŠ¨ç”¨ `docker stop` åœæ‰å…¶ä¸­ä¸€ä¸ªå®¹å™¨ï¼ŒCompose ä¼šè‡ªåŠ¨é‡å¯å®ƒå—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
   1. ä¸ä¼šï¼Œcomposeå‘½ä»¤ä¸ä¼šè‡ªåŠ¨è¿è¡Œï¼Œä½ éœ€è¦æ‰‹åŠ¨ docker compose up

5. æ˜¯å¦æ‰€æœ‰ `docker run` çš„å‚æ•°éƒ½èƒ½åœ¨ Compose ä¸­æ‰¾åˆ°å¯¹åº”é…ç½®ï¼Ÿä¸¾ä¸€ä¸ª**ä¸èƒ½ç›´æ¥å¯¹åº”**çš„ä¾‹å­å¹¶è¯´æ˜åŸå› ã€‚
   1. æˆ‘è®¤ä¸ºå¹¶ä¸å¯ä»¥ï¼Œdocker runæ”¯æŒéå¸¸å¤šçš„å‚æ•°é…ç½®ï¼Œæ¯”å¦‚è¯´ï¼Œcmdï¼Œ endpointï¼Œç­‰ç­‰ï¼Œè¿™äº›å‘½ä»¤å­˜åœ¨ä¸€äº›ç»†èŠ‚çš„å·®å¼‚ï¼Œæˆ‘æƒ³å¹¶ä¸éƒ½èƒ½å¤Ÿåœ¨ç›¸å¯¹å®è§‚çš„compose.ymlä¸­æ‰¾åˆ°å¯¹åº”çš„é…ç½®ã€‚






éå¸¸æ£’çš„æ€è€ƒï¼ä½ å·²ç»æŠ“ä½äº†æ ¸å¿ƒç›´è§‰ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›å…³é”®è¯¯è§£ã€‚æˆ‘ä»¬é€é¢˜åˆ†æå¹¶çº æ­£ã€‚

---

### **é—®é¢˜ 1ï¼šä¿®æ”¹ç¯å¢ƒå˜é‡å `docker compose up` ä¼šç”Ÿæ•ˆå—ï¼Ÿ**

âœ… **ä½ çš„å›ç­”**ï¼šâ€œä¼šç”Ÿæ•ˆâ€¦â€¦è‡ªåŠ¨æ£€æŸ¥å·®å¼‚ï¼Œæ›´æ–°å®¹å™¨ã€‚â€  
ğŸ”¶ **éƒ¨åˆ†æ­£ç¡®ï¼Œä½†æœºåˆ¶ç†è§£æœ‰è¯¯ã€‚**

**æ­£ç¡®è§£é‡Šï¼š**  
- `docker compose up`ï¼ˆæ— å‚æ•°ï¼‰**ä¼šæ£€æµ‹é…ç½®æ˜¯å¦å˜åŒ–**ï¼ˆå¦‚ç¯å¢ƒå˜é‡ã€é•œåƒã€å·ç­‰ï¼‰ã€‚
- å¦‚æœæ£€æµ‹åˆ°**æœåŠ¡å®šä¹‰å˜æ›´**ï¼Œå®ƒä¼š **é‡å»ºï¼ˆrecreateï¼‰è¯¥å®¹å™¨**ï¼ˆå…ˆåˆ æ—§å®¹å™¨ï¼Œå†ç”¨æ–°é…ç½®åˆ›å»ºæ–°å®¹å™¨ï¼‰ã€‚
- æ‰€ä»¥**ä¼šç”Ÿæ•ˆ**ï¼Œä½†ä¸æ˜¯â€œæ›´æ–°åŸå®¹å™¨â€ï¼Œè€Œæ˜¯**æ›¿æ¢ä¸ºæ–°å®¹å™¨**ã€‚

> âœ… ç»“è®ºï¼š**ä¼šç”Ÿæ•ˆï¼Œä½†é€šè¿‡é‡å»ºå®¹å™¨å®ç°ï¼Œä¸æ˜¯çƒ­æ›´æ–°ã€‚**

---

#### è¡¥å……ä½ çš„å¥½å¥‡ï¼šâ€œé‡å¤è¿è¡Œä¸ä¼šåå¤å»ºæ–°å®¹å™¨ï¼Œé ä»€ä¹ˆé¿å…é‡å¤ï¼Ÿâ€

- Compose ä½¿ç”¨ **é¡¹ç›®å + æœåŠ¡å** ç”Ÿæˆ**å”¯ä¸€å®¹å™¨å**ï¼ˆé»˜è®¤æ ¼å¼ï¼š`<project>_<service>_<index>`ï¼‰ã€‚
- å®ƒé€šè¿‡è¿™ä¸ªåç§°è¯†åˆ«å·²æœ‰å®¹å™¨ï¼Œå¹¶å¯¹æ¯”å½“å‰é…ç½®ä¸å®¹å™¨çš„é…ç½®ï¼ˆå­˜å‚¨åœ¨å®¹å™¨æ ‡ç­¾ä¸­ï¼Œå¦‚ `com.docker.compose.config-hash`ï¼‰ã€‚
- å¦‚æœ hash ä¸åŒ â†’ é…ç½®å˜äº† â†’ é‡å»ºå®¹å™¨ã€‚
- æ‰€ä»¥**ä¸æ˜¯é â€œä¸é‡å¤å»ºâ€ï¼Œè€Œæ˜¯é â€œæœ‰å˜åŒ–æ‰é‡å»ºâ€**ã€‚

---

### **é—®é¢˜ 2ï¼š`docker run -p` å’Œ Compose `ports` æ˜¯å¦ç­‰ä»·ï¼Ÿ**

âœ… **ä½ çš„å›ç­”**ï¼šâ€œæˆ‘è®¤ä¸ºæ˜¯ç­‰ä»·çš„ã€‚â€  
ğŸ”¶ **åŸºæœ¬ç­‰ä»·ï¼Œä½†æœ‰ä¸€ä¸ªé‡è¦ç»†å¾®å·®åˆ«ã€‚**

**å…³é”®åŒºåˆ«ï¼šç½‘ç»œæ¨¡å¼**
- `docker run -p 8080:80 nginx` é»˜è®¤ä½¿ç”¨ **bridge ç½‘ç»œ**ï¼Œç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºã€‚
- Compose é»˜è®¤ä¸ºé¡¹ç›®åˆ›å»ºä¸€ä¸ª**è‡ªå®šä¹‰ bridge ç½‘ç»œ**ï¼Œæ‰€æœ‰æœåŠ¡åŠ å…¥å…¶ä¸­ï¼Œ**æœåŠ¡é—´å¯é€šè¿‡æœåŠ¡å DNS é€šä¿¡**ã€‚
- è™½ç„¶ç«¯å£æ˜ å°„æ•ˆæœä¸€æ ·ï¼Œä½† **Compose ä¸­çš„å®¹å™¨é»˜è®¤ä¸åœ¨ `docker0` é»˜è®¤ bridge ä¸Š**ï¼Œè€Œæ˜¯åœ¨ä¸“å±ç½‘ç»œä¸­ã€‚

> âœ… ç»“è®ºï¼š**ç«¯å£æ˜ å°„è¡Œä¸ºç­‰ä»·ï¼Œä½†ç½‘ç»œä¸Šä¸‹æ–‡ä¸åŒï¼ˆCompose æœ‰éš”ç¦»ç½‘ç»œï¼‰ã€‚**

---

### **é—®é¢˜ 3ï¼šèƒ½å¦åœ¨ Compose ä¸­å®ç° `--rm`ï¼ˆé€€å‡ºå³åˆ é™¤ï¼‰ï¼Ÿ**

âŒ **ä½ çš„å›ç­”**ï¼šâ€œä¸çŸ¥é“ã€‚â€  
âœ… **å¯ä»¥ï¼ä½†æ–¹å¼ä¸åŒã€‚**

Compose **é»˜è®¤ä¸ä¼šè‡ªåŠ¨åˆ é™¤å®¹å™¨**ï¼ˆå³ä½¿é€€å‡ºï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†ä¿ç•™æ—¥å¿—ã€è°ƒè¯•çŠ¶æ€ã€‚

ä½†ä» **Docker Compose v2.20+ï¼ˆæˆ– Docker Desktop è¾ƒæ–°ç‰ˆæœ¬ï¼‰** å¼€å§‹ï¼Œæ”¯æŒï¼š

```yaml
services:
  myapp:
    image: alpine
    command: echo hello
    restart: "no"          # ä¸é‡å¯
    labels:
      com.docker.compose.stop-signal: SIGTERM
    # å…³é”®ï¼šä½¿ç”¨ auto_removeï¼ˆå®éªŒæ€§ï¼Œä½†å·²å¹¿æ³›æ”¯æŒï¼‰
    auto_remove: true
```

æˆ–è€…æ›´é€šç”¨çš„æ–¹å¼ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰ï¼š
- **ä¸èƒ½ç›´æ¥å†™ `--rm`**ï¼Œä½†ä½ å¯ä»¥ï¼š
  - è¿è¡Œä¸€æ¬¡ä»»åŠ¡ç”¨ `docker compose run --rm service_name`
  - æˆ–è€…ç”¨ `docker compose up` å¯åŠ¨åï¼Œ**æ‰‹åŠ¨æ¸…ç†**ï¼š`docker compose down`

> âš ï¸ æ³¨æ„ï¼š`auto_remove` åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æœªé«˜äº®ï¼Œä½†åœ¨å¼•æ“å±‚é¢æ”¯æŒï¼ˆé€šè¿‡ `HostConfig.AutoRemove`ï¼‰ã€‚

âœ… **ç»“è®ºï¼šèƒ½å®ç°ï¼Œä½†éœ€ç”¨ `auto_remove: true` æˆ–æ”¹ç”¨ `docker compose run --rm`ã€‚**

---

### **é—®é¢˜ 4ï¼šæ‰‹åŠ¨ `docker stop` å®¹å™¨ï¼ŒCompose ä¼šè‡ªåŠ¨é‡å¯å—ï¼Ÿ**

âœ… **ä½ çš„å›ç­”**ï¼šâ€œä¸ä¼šï¼Œéœ€è¦æ‰‹åŠ¨ `docker compose up`ã€‚â€  
ğŸ”¶ **åŸºæœ¬æ­£ç¡®ï¼Œä½†åŸå› å¯æ›´ç²¾ç¡®ã€‚**

**è¯¦ç»†è§£é‡Šï¼š**
- Compose **æœ¬èº«ä¸æ˜¯å®ˆæŠ¤è¿›ç¨‹**ï¼Œå®ƒåªåœ¨ä½ è¿è¡Œå‘½ä»¤æ—¶å·¥ä½œã€‚
- å®¹å™¨çš„**é‡å¯è¡Œä¸ºç”±å®¹å™¨è‡ªèº«çš„ `restart` ç­–ç•¥å†³å®š**ï¼ˆå¦‚ `restart: always`ï¼‰ã€‚
- å¦‚æœä½ åœ¨ Compose æ–‡ä»¶ä¸­å†™äº†ï¼š
  ```yaml
  restart: unless-stopped
  ```
  é‚£ä¹ˆå³ä½¿ä½  `docker stop`ï¼Œ**Docker å¼•æ“**ï¼ˆä¸æ˜¯ Composeï¼‰ä¼šåœ¨ Docker æœåŠ¡é‡å¯åæ‹‰èµ·å®¹å™¨ã€‚
- ä½†å¦‚æœä½ åªæ˜¯ `docker stop`ï¼Œ**ä¸”æ²¡æœ‰è®¾ç½® `restart` ç­–ç•¥**ï¼Œå®¹å™¨å°±åœäº†ï¼ŒCompose ä¸ä¼šå¹²é¢„ã€‚

> âœ… ç»“è®ºï¼š**Compose ä¸ç›‘æ§å®¹å™¨çŠ¶æ€ï¼›æ˜¯å¦é‡å¯å–å†³äºå®¹å™¨çš„ `restart` ç­–ç•¥å’Œ Docker å¼•æ“ï¼Œè€Œé Compose æœ¬èº«ã€‚**

---

### **é—®é¢˜ 5ï¼šæ˜¯å¦æ‰€æœ‰ `docker run` å‚æ•°éƒ½èƒ½åœ¨ Compose ä¸­å¯¹åº”ï¼Ÿ**

âœ… **ä½ çš„ç›´è§‰å¯¹**ï¼šâ€œå¹¶ä¸éƒ½å¯ä»¥ã€‚â€  
ä½†ä¾‹å­ä¸å¤Ÿå‡†ç¡®ã€‚

**æ­£ç¡®ç­”æ¡ˆï¼š**
- **ç»å¤§å¤šæ•°** `docker run` å‚æ•°éƒ½æœ‰ Compose å¯¹åº”é¡¹ï¼ˆå¦‚ `environment`, `volumes`, `ports`, `command`, `entrypoint` ç­‰ï¼‰ã€‚
- **ä½†æœ‰äº›æ— æ³•ç›´æ¥å¯¹åº”**ï¼Œä¾‹å¦‚ï¼š

> âŒ **`docker run --interactive (-i)` å’Œ `--tty (-t)` çš„äº¤äº’å¼ä¼šè¯**

- åœ¨ `docker-compose.yml` ä¸­ï¼Œä½ **ä¸èƒ½ç›´æ¥è·å¾—äº¤äº’å¼ç»ˆç«¯**ã€‚
- è™½ç„¶å¯ä»¥å†™ï¼š
  ```yaml
  stdin_open: true   # ç›¸å½“äº -i
  tty: true          # ç›¸å½“äº -t
  ```
  ä½†è¿™åªåœ¨ **`docker compose run`** æ—¶æœ‰æ•ˆï¼Œ**`docker compose up` é»˜è®¤æ˜¯éäº¤äº’å¼çš„**ï¼Œæ— æ³•è¾“å…¥ã€‚

å¦ä¸€ä¸ªä¾‹å­ï¼š
> âŒ **`docker run --rm`**ï¼ˆå‰é¢å·²è®²ï¼ŒCompose é»˜è®¤ä¸è‡ªåŠ¨åˆ ï¼‰

è¿˜æœ‰ä¸€ä¸ªé«˜çº§ä¾‹å­ï¼š
> âŒ **`docker run --gpus all`**  
> åœ¨æ—§ç‰ˆ Compose ä¸­ä¸æ”¯æŒï¼Œéœ€ç”¨ `deploy.resources.reservations.devices`ï¼ˆä»…é™ Swarm æ¨¡å¼ï¼‰æˆ–æ–°ç‰ˆ Compose çš„ `runtime` / `device` æ‰©å±•ã€‚

âœ… **ç»“è®ºï¼šå¤§éƒ¨åˆ†èƒ½å¯¹åº”ï¼Œä½†äº¤äº’å¼ã€ä¸´æ—¶æ€§ã€è°ƒè¯•ç±»å‚æ•°ï¼ˆå¦‚ `--rm`, `-it`ï¼‰åœ¨ `up` åœºæ™¯ä¸‹æ— æ³•å®Œå…¨å¤ç°ã€‚**

---

### ğŸ” æ€»ç»“ä½ çš„ç†è§£æ¼æ´

| ä½ çš„ç†è§£                       | å®é™…æƒ…å†µ                               | å…³é”®çº æ­£                                 |
| ------------------------------ | -------------------------------------- | ---------------------------------------- |
| Compose ä¿®æ”¹åâ€œæ›´æ–°â€å®¹å™¨       | å®é™…æ˜¯**é‡å»º**å®¹å™¨                     | å®¹å™¨æ˜¯ä¸å¯å˜çš„ï¼ŒCompose é€šè¿‡æ›¿æ¢å®ç°å˜æ›´ |
| Compose = æ‰“åŒ… docker run      | å¿½ç•¥äº†**ç½‘ç»œã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€çŠ¶æ€è·Ÿè¸ª** | Compose æ˜¯å£°æ˜å¼ç¼–æ’ï¼Œä¸æ˜¯å‘½ä»¤é›†åˆ       |
| æ‰€æœ‰ `docker run` åŠŸèƒ½éƒ½èƒ½æ˜ å°„ | **äº¤äº’å¼ã€ä¸´æ—¶æ€§å‚æ•°**åœ¨ `up` ä¸­å—é™   | `up` æ˜¯éäº¤äº’åå°æ¨¡å¼ï¼Œ`run` æ‰ç”¨äºäº¤äº’  |
| Compose ä¼šç›‘æ§å®¹å™¨             | Compose **æ— å®ˆæŠ¤è¿›ç¨‹**ï¼Œä¸ç›‘æ§         | é‡å¯é  Docker å¼•æ“çš„ `restart` ç­–ç•¥      |
| ç«¯å£æ˜ å°„å®Œå…¨ç­‰ä»·               | ç½‘ç»œä¸Šä¸‹æ–‡ä¸åŒï¼ˆé»˜è®¤è‡ªå®šä¹‰ç½‘ç»œï¼‰       | Compose æœåŠ¡é—´é€šä¿¡ç”¨å†…éƒ¨ DNS             |

---

å¦‚æœä½ æƒ³ç»§ç»­æ·±å…¥ï¼Œæˆ‘å¯ä»¥ï¼š
- ç»™ä½ ä¸€ä¸ªæœ€å° Compose vs docker run å¯¹ç…§è¡¨
- æ¼”ç¤ºå¦‚ä½•ç”¨ `docker compose run --rm -it` åšè°ƒè¯•
- è§£é‡Š `docker compose up` vs `start` vs `run` çš„åŒºåˆ«

è¦ç»§ç»­å—ï¼Ÿ





å½“ç„¶å¯ä»¥ï¼ä¸‹é¢æˆ‘å°†æä¾› **ä¸¤ä¸ªå®Œæ•´ã€å¯è¿è¡Œçš„æ¡ˆä¾‹**ï¼š

1. **çº¯ `docker run` æ–¹å¼è¿è¡Œ Kibanaï¼ˆè¿æ¥æœ¬åœ° Elasticsearchï¼‰**
2. **ä½¿ç”¨ `docker-compose.yml` æ–¹å¼è¿è¡Œ Kibana + Elasticsearch ä¸€ä½“ç¯å¢ƒ**

ä¸¤è€…éƒ½é™„å¸¦**é€è¡Œè¯¦ç»†æ³¨è§£**ï¼Œå¹¶è¯´æ˜å…³é”®å·®å¼‚ã€‚

---

## âœ… å‰ææ¡ä»¶

- å·²å®‰è£… Dockerï¼ˆç‰ˆæœ¬ â‰¥ 20.10ï¼‰
- ç«¯å£ `9200`ï¼ˆElasticsearchï¼‰å’Œ `5601`ï¼ˆKibanaï¼‰æœªè¢«å ç”¨
- æœ¬ä¾‹ä½¿ç”¨ **Elasticsearch 8.x + Kibana 8.x**ï¼ˆé»˜è®¤å¯ç”¨å®‰å…¨ç‰¹æ€§ï¼‰

> ğŸ’¡ æ³¨æ„ï¼šElasticsearch 8 é»˜è®¤å¼€å¯ TLS å’Œç”¨æˆ·è®¤è¯ï¼Œé…ç½®ç¨å¤æ‚ã€‚ä¸ºç®€åŒ–ï¼Œæˆ‘ä»¬**ä¸´æ—¶å…³é—­å®‰å…¨åŠŸèƒ½**ç”¨äºæ¼”ç¤ºï¼ˆä»…é™å¼€å‘/å­¦ä¹ ç¯å¢ƒï¼‰ã€‚

---

## ğŸ“Œ æ¡ˆä¾‹ä¸€ï¼šä½¿ç”¨ `docker run` å•ç‹¬è¿è¡Œ Kibana

> å‡è®¾ä½ **å·²æœ‰æœ¬åœ°è¿è¡Œçš„ Elasticsearchï¼ˆå¦‚å®¿ä¸»æœº 127.0.0.1:9200ï¼‰**ï¼Œä¸”å·²å…³é—­å®‰å…¨éªŒè¯ã€‚

```bash
docker run -d \
  --name kibana-standalone \
  --network host \                  # ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼ˆç›´æ¥è®¿é—® localhost:9200ï¼‰
  -e ELASTICSEARCH_HOSTS=http://localhost:9200 \
  -e SERVER_NAME=kibana.local \
  -e SERVER_HOST="0.0.0.0" \        # å…è®¸å¤–éƒ¨è®¿é—®å®¹å™¨å†…æœåŠ¡
  -p 5601:5601 \                    # æ˜ å°„ Kibana Web ç«¯å£
  docker.elastic.co/kibana/kibana:8.12.0
```

### ğŸ” é€è¡Œæ³¨è§£ï¼š

| è¡Œ                           | è¯´æ˜                                                         |
| ---------------------------- | ------------------------------------------------------------ |
| `docker run -d`              | åå°è¿è¡Œå®¹å™¨                                                 |
| `--name kibana-standalone`   | ç»™å®¹å™¨å‘½åï¼Œä¾¿äºç®¡ç†                                         |
| `--network host`             | **å…³é”®ï¼** ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œè¿™æ · `localhost:9200` æŒ‡å‘çš„æ˜¯ä½ æœ¬æœºçš„ ESï¼Œè€Œä¸æ˜¯å®¹å™¨å†…éƒ¨ã€‚è‹¥ä¸ç”¨æ­¤æ¨¡å¼ï¼Œéœ€ç”¨å®¿ä¸»æœº IP æˆ–è‡ªå®šä¹‰ç½‘ç»œ |
| `-e ELASTICSEARCH_HOSTS=...` | å‘Šè¯‰ Kibana Elasticsearch åœ°å€ï¼ˆå¿…é¡»èƒ½ä»å®¹å™¨å†…è®¿é—®ï¼‰         |
| `-e SERVER_HOST="0.0.0.0"`   | è®© Kibana ç›‘å¬æ‰€æœ‰æ¥å£ï¼ˆå¦åˆ™é»˜è®¤åªç›‘å¬ 127.0.0.1ï¼Œå¤–éƒ¨æ— æ³•è®¿é—®ï¼‰ |
| `-p 5601:5601`               | å°†å®¹å™¨ 5601 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºï¼ˆå³ä½¿ç”¨äº† host ç½‘ç»œï¼Œæ˜¾å¼å£°æ˜æ›´æ¸…æ™°ï¼‰ |
| `kibana:8.12.0`              | ä½¿ç”¨å®˜æ–¹é•œåƒï¼ˆå»ºè®®å›ºå®šç‰ˆæœ¬ï¼‰                                 |

> âš ï¸ **å±€é™æ€§**ï¼š  
> - å¦‚æœ Elasticsearch ä¹Ÿåœ¨å®¹å™¨ä¸­ï¼Œ`--network host` ä¼šå¯¼è‡´ Kibana æ— æ³•é€šè¿‡å®¹å™¨åè®¿é—® ESã€‚  
> - å®‰å…¨é…ç½®ï¼ˆå¦‚ TLSã€ç”¨æˆ·åå¯†ç ï¼‰éœ€é¢å¤–åŠ ç¯å¢ƒå˜é‡ï¼Œè¾ƒç¹çã€‚

---

## ğŸ“Œ æ¡ˆä¾‹äºŒï¼šä½¿ç”¨ `docker-compose.yml` è¿è¡Œ Kibana + Elasticsearch

åˆ›å»ºæ–‡ä»¶ `docker-compose.yml`ï¼š

```yaml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: es-node
    environment:
      # å…³é—­å®‰å…¨åŠŸèƒ½ï¼ˆä»…ç”¨äºå¼€å‘ï¼ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…å¼€å¯ï¼‰
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.monitoring.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"   # REST API
      - "9300:9300"   # èŠ‚ç‚¹é—´é€šä¿¡ï¼ˆæ­¤å¤„å•èŠ‚ç‚¹ï¼Œå¯çœç•¥ï¼‰
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - elastic-net

  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.0
    container_name: kibana-ui
    depends_on:
      - elasticsearch   # ç¡®ä¿ ES å…ˆå¯åŠ¨
    environment:
      - ELASTICSEARCH_HOSTS=["http://es-node:9200"]
      - SERVER_HOST="0.0.0.0"
    ports:
      - "5601:5601"
    networks:
      - elastic-net
    restart: unless-stopped

volumes:
  es_data:   # æŒä¹…åŒ– ES æ•°æ®

networks:
  elastic-net:
    driver: bridge   # åˆ›å»ºä¸“ç”¨ç½‘ç»œï¼ŒæœåŠ¡å¯é€šè¿‡æœåŠ¡åé€šä¿¡
```



å’Œæˆ‘å½“æ—¶åœ¨SmartPaiä¸­çš„å‘½ä»¤è¿›è¡Œæ¯”è¾ƒä¸€ä¸‹ã€‚

```yaml
  es:
    image: elasticsearch:8.10.4
    container_name: es
    restart: always
    ports:
      - 9200:9200
    volumes:
      - es-data:/usr/share/elasticsearch/data
    environment:
      - ELASTIC_PASSWORD=PaiSmart2025
      - node.name=pai-smart-es01
      - discovery.type=single-node
      - xpack.license.self_generated.type=basic
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=false
      - xpack.security.http.ssl.enabled=false
      - cluster.name=pai-smart-es-cluster

      # å†…å­˜é…ç½® (æ ¹æ®å¯ç”¨RAMè°ƒæ•´)
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
    deploy:
      resources:
        limits:
          memory: 2g
    command: >
      bash -c "
      if ! elasticsearch-plugin list | grep -q 'analysis-ik'; then
        echo 'Installing analysis-ik plugin...';
        elasticsearch-plugin install --batch https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.10.4.zip;
      else
        echo 'analysis-ik plugin already installed.';
      fi;
      /usr/local/bin/docker-entrypoint.sh
      "
    healthcheck:
      test: [ 'CMD', 'curl', '-s', 'http://localhost:9200/_cluster/health?pretty' ]
      interval: 30s
      timeout: 10s
      retries: 3
```





### ğŸ” é€æ®µæ³¨è§£ï¼š

#### âœ… `version: '3.8'`
- Compose æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬ï¼ˆ3.8 æ”¯æŒå¤§å¤šæ•°ç°ä»£åŠŸèƒ½ï¼‰

#### âœ… `elasticsearch` æœåŠ¡
- `discovery.type=single-node`ï¼šå•èŠ‚ç‚¹æ¨¡å¼ï¼ˆé¿å…é›†ç¾¤å‘ç°é”™è¯¯ï¼‰
- `xpack.security.enabled=false`ï¼š**å…³é—­å®‰å…¨**ï¼ˆå¦åˆ™éœ€é…ç½®è¯ä¹¦å’Œå¯†ç ï¼‰
- `volumes: es_data`ï¼šæ•°æ®æŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢æ•°æ®
- `networks: elastic-net`ï¼šåŠ å…¥è‡ªå®šä¹‰ç½‘ç»œ

#### âœ… `kibana` æœåŠ¡
- `depends_on`ï¼šç¡®ä¿å…ˆå¯åŠ¨ ESï¼ˆä½†**ä¸ç­‰ ES å°±ç»ª**ï¼Œä»…ç­‰å®¹å™¨å¯åŠ¨ï¼‰
- `ELASTICSEARCH_HOSTS=["http://es-node:9200"]`ï¼š**å…³é”®ï¼** ä½¿ç”¨ **æœåŠ¡å `es-node`** ä½œä¸ºä¸»æœºåï¼ˆDocker å†…ç½® DNSï¼‰
- `networks: elastic-net`ï¼šå’Œ ES åœ¨åŒä¸€ç½‘ç»œï¼Œå¯ç›´æ¥é€šä¿¡
- `restart: unless-stopped`ï¼šå®¹å™¨å´©æºƒæˆ– Docker é‡å¯æ—¶è‡ªåŠ¨æ‹‰èµ·

#### âœ… `volumes` å’Œ `networks`
- è‡ªåŠ¨åˆ›å»ºå‘½åå· `es_data` å’Œæ¡¥æ¥ç½‘ç»œ `elastic-net`
- æœåŠ¡é—´é€šè¿‡ **æœåŠ¡å**ï¼ˆå³ `elasticsearch` æˆ– `container_name`ï¼‰è§£æ IP

---

## â–¶ï¸ å¦‚ä½•è¿è¡Œï¼Ÿ

åœ¨ `docker-compose.yml` æ‰€åœ¨ç›®å½•æ‰§è¡Œï¼š

```bash
# å¯åŠ¨
docker compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f kibana

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™å·ï¼‰
docker compose down

# å½»åº•æ¸…ç†ï¼ˆå«æ•°æ®å·ï¼‰
docker compose down -v
```

ç„¶åæµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5601

---

## ğŸ” å¯¹æ¯”æ€»ç»“ï¼š`docker run` vs `docker compose`

| èƒ½åŠ›       | `docker run`          | `docker compose`           |
| ---------- | --------------------- | -------------------------- |
| å¤šå®¹å™¨ç¼–æ’ | âŒ éœ€æ‰‹åŠ¨ç®¡ç†å¤šä¸ªå‘½ä»¤  | âœ… ä¸€é”®å¯åœæ•´ä¸ªåº”ç”¨         |
| å®¹å™¨é—´é€šä¿¡ | âŒ éœ€æ‰‹åŠ¨å»ºç½‘ç»œã€è®° IP | âœ… è‡ªåŠ¨ DNSï¼ˆç”¨æœåŠ¡åï¼‰     |
| é…ç½®å¤ç”¨   | âŒ é•¿å‘½ä»¤éš¾ç»´æŠ¤        | âœ… YAML å£°æ˜å¼ï¼Œç‰ˆæœ¬å¯æ§    |
| æ•°æ®æŒä¹…åŒ– | âš ï¸ éœ€æ‰‹åŠ¨æŒ‚è½½å·        | âœ… å£°æ˜ `volumes` è‡ªåŠ¨ç®¡ç†  |
| ä¾èµ–æ§åˆ¶   | âŒ æ—                   | âœ… `depends_on`ï¼ˆåŸºç¡€ä¾èµ–ï¼‰ |
| ç”Ÿäº§é€‚ç”¨æ€§ | âŒ ä»…é€‚åˆç®€å•åœºæ™¯      | âœ… å¼€å‘/æµ‹è¯•/è½»é‡ç”Ÿäº§       |

---

## ğŸ›‘ å®‰å…¨æé†’ï¼ˆé‡è¦ï¼ï¼‰

ä»¥ä¸Šç¤ºä¾‹**å…³é—­äº† Elasticsearch å®‰å…¨åŠŸèƒ½**ï¼Œ**ç»å¯¹ä¸å¯ç”¨äºç”Ÿäº§ç¯å¢ƒ**ï¼  
ç”Ÿäº§éƒ¨ç½²åº”ï¼š
- å¯ç”¨ TLS åŠ å¯†
- é…ç½®ç”¨æˆ·å/å¯†ç ï¼ˆå¦‚ `elastic` ç”¨æˆ·ï¼‰
- ä½¿ç”¨ `elasticsearch-setup-passwords` å·¥å…·
- æˆ–ä½¿ç”¨ Elastic å®˜æ–¹æä¾›çš„ [å®‰å…¨ Compose æ¨¡æ¿](https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html)

---

éœ€è¦æˆ‘æä¾›ä¸€ä¸ª**å¸¦å®‰å…¨è®¤è¯çš„ Compose ç¤ºä¾‹**å—ï¼Ÿæˆ–è€…æƒ³äº†è§£å¦‚ä½•ç”¨ `docker compose` åŠ¨æ€æ›´æ–° Kibana é…ç½®ï¼Ÿ