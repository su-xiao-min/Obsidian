华为HMS PUSH接入
周朝勇
管理信息部
摘要：本文直接采用RN+原生安卓桥接方式，通过安卓原生方法调用华为的SDK，接入华为手机HMS PUSH消息推送。
关键词：React Native；HMS PUSH消息推送
1注册应用
打开并登录下列链接，选择添加应用，输入对应的应用名称。

2选择数据存储位置
点击下图框选“管理”，选择中国。

3添加证书指纹
打开cmd，进入jdk/bin目录，执行如下命令。将最后的位置替换成实际密钥文件位置，最后是密钥文件的完整文件名，对应替换即可。

点击如下图框选的按钮，将cmd窗口中得到的SHA256密钥复制粘贴到输入框内。

4开通服务
点击左侧的推送服务，选择配置页签，在如下图页面开启推送服务。

点击下图按钮。

选择新增类型，按照app需求选择对应的分类，点击下一步填写示例消息，提交等待审核通过即可。

5下载配置文件
点击下图框选位置，下载文件，可选择不包含密钥（此方式需要自行在app中编写获取app_id等信息的逻辑）。

6应用配置
将上一步下载的文件放到\android\app目录下。修改\android目录下的build.gradle文件，修改如下，其中涉及到版本号的自行替换实际版本。

修改\android\app目录下的build.gradle文件，修改如下。

其中建议将debug的配置与线上配置一致，如果不一致测试时从创建应用到测试需要全程使用同一个密钥文件。

修改AndroidManifest.xml，增加如下图所示配置

7编写桥接代码
HmsPushPackage.kt

HmsPushModule.kt

HmsMessagePushService.kt

HmsEventEmitter.kt

MainApplication.kt，在该文件的相同位置中添加如下代码。

8编写RN调用中心
HmsMessageCenter.ts

9调用
根据实际情况修改下列代码，核心就是new HmsMessageCenter，调用init，然后调用getRegistrationId，将唯一标识传递到后端，后端可以根据该标识给指定设备发送消息。
注意：不要连续调用getRegistrationId，这个是长期有效的，失效情况参考最新的官方说明，连续调用可能导致服务被关闭。

10服务端调用
10.1获取服务端令牌

注意：实际开发时api地址和参数可能有所变化，自行参考最新的文档做对应的调整。下列是截止文档编写时的文档链接。

此外，建议保持提前随机时间失效的实现，这样可以极大程度避免华为服务器上优先过期，导致令牌短期内失效的问题，只要不是短时间内频繁获取就不会被风控（截止文档编辑时是1000/5分钟）。
其中clientId和clientSecret为下列图片框选位置的值。

10.2注册设备标识
前端调用这个实现，将华为发放的token传递到服务端存储，后续服务端使用该token给设备发送消息。

10.3消息发送实现

注意：实际开发过程中url和参数可能有所变化，下列链接是截止文档编写时刻的参数文档链接。其中category替换为实际发送消息的类型，可以参考下列官方链接中的文档

如果需要显示角标需要在AndroidManifest.xml中添加如下图所示配置。

11清除角标
点击通知栏并不会自动清除app右上角的数量角标，需要自行编写接口清除。
11.1桥接接口
在HmsPushModule.kt中增加如下方法。

注意Log需要导包

11.2调用桥接方法
在HmsMessageCenter中增加如下方法，并且在需要清除的地方调用该方法。

12踩坑
run android 期间如果遇到打包失败，找不到华为AGC，可以将华为maven仓库的设置提到最前面。
如果RN调用不成功，可以使用Android Studio打开，选择view->Tool Windows->Logcat，搜索HMS，这里可以看到华为相关的报错信息，如果没有也可以自行在对应kt代码位置编写打印。
RN调用HMS的getToken返回907135000，该错误码表示鉴权不通过，有多种原因，可能是agconnect-services.json的位置不对，应用SHA256未填写或不一致，agconnect-services.json文件中未正确包含appId等信息，当前环境使用的密钥文件与SHA256生成时不一致，AGC插件引入失败等。可以在AS中查看详细的日志排查。
Get client/app_id failed: java.io.FileNotFoundException: agconnect-services.json，如果AS日志中显示这个错误，要么是文件位置不对，要么就是AGC未成功引入，检查\android\app\build.gradle文件头部是否添加了

6003，出现这个异常码需要检查当前环境生效的密钥文件与华为平台上传、SHA256生成来源的是否都一致。
消息推送如果接口调用正常，手机端无法接收到消息或无法正常显示数字角标，仔细检查接口参数层级是否和文档一一对应。
13结论
本文介绍了React Native应用接入华为HMS PUSH服务的全流程，包含过程中遇到的问题以及对应的解决方案。

你参考一下 docs\bug_analysis_have_sent.md,帮我解决一下问题

我启动前端，
前端可以正常使用，
但是会出现这个runtime errors，
帮我分析一下，
请问是什么东西过时了。

我启动前端，
前端可以正常使用，
但是会出现这个runtime errors，
帮我分析一下，
请问是什么东西过时了。

反正有什么，
就先写在这里吧。
反正这段时间也折腾了蛮多东西的。
之后还要在自己的电脑上再折腾一边，
想想就很开心。
想想，就有一点乏力了。
下一个接手这台电脑的人，
我会给你留下什么呢？

感觉一直都很麻烦，

我明明记得自己保存了的，
但是总是忘记，
还是应该尽可能避开打开太多窗口。
随便学习，

看一下我leetcode76题的解法是否存在问题
