## 项目问题

我感觉ChatGPT，感觉和它多交流几轮，我对于技术的理解会更深入一些。

首先是，我需要思考，也是我后面实际开发过程中遇到的一个非常愚蠢但是好笑的Bug。

当时我经过很多轮的联调，终于跑通了流程，结果遇到了一个很奇怪的问题。就是，
即使我的OSS的服务通过了，
即使我的OCR也反过来结果，
即使返回的结果也确实在前端显示了，
但是，图片呈现的状态依旧是不能被获取的。

为什么呢？
后来debug的时候注意到，因为status没有及时的更新。
也就是说，我后面写入Elasticsearch的过程还是会影响我的状态，
我的图片很尴尬地处在可以查看，但是无法检索的状态。

我必须要思考，如果项目的流程跑不通才会出现怎样的问题。

### 图片上传环节的问题

我设计的是用户先上传图片，再填写元数据，感觉也没有什么好处。

> 你现在的真实流程是：
> 
> 用户拿到预签名
> 
> 图片已经进 OSS
> 
> 用户“理论上”再补元数据
> 
> 问题来了：
> 
> 用户上传完图片就关页面了怎么办？
> 
> 网络断了，元数据没传怎么办？
> 
> 用户传了图，但元数据缺字段怎么办？
> 
> 你现在**已经制造了“孤儿资源”**的可能性。

ChatGPT的锐评。

所以，最后的思路是，资源存在一个

建议最小修正，不推翻你设计：

后端生成一个 image_id（或 resource_id）

预签名绑定这个 id

上传完成后，资源状态是 UPLOADED_NO_METADATA

只有元数据提交成功，状态才变 READY_FOR_OCR

> 挺好的字体，中文排版也不错。

> 还是存在一点问题，这个应用，它就会带来无法对齐的情况，中英文同时存在的时候，排版就是让人很头大，从前是，现在还是。

所以，其实存在两个状态，一个是MySQL当中的持久化状态，另外一个则是Redis当中的快速变化的状态。

我们的数据库应该自己设置一个定时任务，或者我可以使用Spring的框架来解决。有时间去看一下这一点。<M-C-S-F10>l

### 异步机制实际上的实现

暂时还不引入MQ，只是提供一个回调接口，这种设计也非常不错。

### 打破顺利幻想

目前我的设计当中，Redis里面只存着任务id，但是这样还是太简单了

高低我得多存一点内容。
```json
{
  "task_id": "...",
  "image_id": "...",
  "user_id": "...",
  "org_id": "...",
  "status": "pending",
  "created_at": ...
}
```

反正对于我们伟大的Redis，多存一点数据也问题不大。

### :two:OCR → MySQL → Embedding → ES 是一条“死亡链”

草，你说得太对了，原来你在Claude 开始写代码之前就已经把所有的问题都想好了，你提到的问题我全部都遇到了，全部都没有解决。

所以，我们引入了索引状态。

使用索引状态，就知道遇到了问题应该怎样回滚。

这样有问题了就可以重新使用。

索引状态

- METADATA_SAVED
- VECTOR_PENDING
- INDEXED
- INDEXED_FAILED

所以我们现在就应该去询问自己，图片处在怎样的状态。

为什么没有前两种状态对应的FAILED呢？

我们的Redis记录里面应该存在，它更新的时间，我们会定期检查，如果出现问题，那么就直接回溯。

换言之，如果停留在VECTOR_PENDING太久的图片，我们首先会直接调用查询的方法，如果查不到，我们就直接重新OCR。后续这里我们可以把这种失败的任务添加到消息队列当中，让另外一个队列再去重试。

上面的索引状态应该是不完全的。


```txt
四、现在你该担心什么，不该担心什么
✔ 你现在已经过关的部分

模块拆分是合理的

OCR 异步意识是对的

不上 RAG 的决定是成熟的

技术选型没有明显作死行为

✖ 你现在真正欠的账

资源状态机

任务状态机

失败路径设计

接口契约统一（字段名、状态值、返回结构）

你现在写的是：

“一切顺利时的系统”

你下一步要写的是：

“出事时不装死的系统”
```

我真的好想大骂一下自己，如果我在开发项目之前再好好看一下ChatGPT老师的锐评，我何苦走到今天这一步。

```chatGPT
有了回调机制，还要不要 Redis？

结论先给：

要，但用途变了；不用来“等结果”，而用来“托底系统理智”。

你现在已经意识到一件关键的事了：
轮询是 Redis 最差的一种用法。
```

Redis 应用记录的是任务的结果。

合理的任务分工应该如下

| 层级 | 放什么           |
| ---  | -----------------|
|Redis |任务的临时状态    |
|MySQL |已经成立的事实    |
|ES    |检索试图          |


```status
INIT                // 元数据已提交
OCR_DONE            // OCR 成功
METADATA_SAVED      // MySQL 已写
VECTOR_PENDING      // 等 embedding
VECTOR_DONE         // embedding 成功
INDEXED             // ES 写入完成
INDEX_FAILED        // 任一步失败
```

chatGPT 给我提供了如上的状态管理，但是，我本人还是比较困扰。

这是一个复杂的状态机。

我得待会去询问一下。

直接使用索引状态枚举，感觉复杂度有一点高。

所以我们就上了消息队列

回滚不是“撤销”，而应该是停止推进。

## 资源状态机

hatGPT就非常深刻回答了我，资源状态机和任务状态机的区别。

换言之，前者是需要持久化的存在，决定了这个东西和前端怎样交互，怎样呈现，换言之，前端需要注意到这些内容，反过来说，任务状态机
